# CI/CD Pipeline for Flipso E-commerce (ASP.NET Core)
# --- IMPORTANT: Ensure proper indentation. YAML is whitespace sensitive! ---


trigger:
- main # Triggers the pipeline on every push to the 'main' branch

pool:
  vmImage: 'windows-latest' # Use a Windows agent for the build

# =================================================================
# VARIABLES: Customize these values
# =================================================================
variables:
  # General Build Variables
  buildConfiguration: 'Release' 
  
  # Azure Web App Variables (CRITICAL: Replace with your values)
  azureServiceName: 'flipsowebapp-gharijit'
  azureSubscription: 'Flipso-Azure-Connection' 
  artifactName: 'drop' # Name of the package artifact

# =================================================================
# STAGE 1: Continuous Integration (CI - Build, Test, Package)
# =================================================================
stages:
- stage: Build
  displayName: CI - Build and Package Application
  jobs:
  - job: BuildJob
    steps:
    
    # 1. Install/Use .NET SDK
    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        version: '8.x' # Ensure this matches your project's target framework
        packageType: 'sdk'

    # 2. Restore Dependencies
    - task: DotNetCoreCLI@2
      displayName: 'Restore Dependencies'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'

    # 3. Build the Application
    - task: DotNetCoreCLI@2
      displayName: 'Build Project'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

    # 4. Publish the Web App (Creates the deployable .zip package)
    - task: DotNetCoreCLI@2
      displayName: 'Publish Web App'
      inputs:
        command: 'publish'
        publishWebProjects: true 
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true 

    # 5. Publish Artifact (Saves the .zip file for the Deployment stage)
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: '$(artifactName)'

# =================================================================
# STAGE 2: Continuous Deployment (CD - Deploy to Azure Web App)
# =================================================================
- stage: Deploy
  displayName: CD - Deploy to Azure Web App
  dependsOn: Build 
  condition: succeeded() 
  jobs:
  - deployment: DeployJob
    displayName: Deploy Web App
    environment: 'Flipso-Production' # Descriptive name for the deployment environment
    pool:
      vmImage: 'windows-latest'
      
    # -------------------------------------------------------------
    # FIX APPLIED: 'steps' moved under 'strategy > runOnce > deploy'
    # -------------------------------------------------------------
    strategy: 
      runOnce: 
        deploy: 
          steps: # <--- CORRECT LOCATION for steps inside a deployment job
          
          # 1. Download Artifact 
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Artifact'
            inputs:
              buildType: 'current'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'
              
          # 2. Deploy to Azure Web App 
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: '$(azureSubscription)' 
              appName: '$(azureServiceName)' 
              package: '$(System.ArtifactsDirectory)/$(artifactName)/**/*.zip'
