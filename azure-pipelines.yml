# Full CI/CD Pipeline for Flipso E-commerce (ASP.NET Core)
# This pipeline runs on the self-hosted agent named 'default'

trigger:
- main # Triggers the pipeline on every push to the 'main' branch

# =================================================================
# VARIABLES: CRITICAL - Update these three lines with your values
# =================================================================
variables:
  # General Build Variables
  buildConfiguration: 'Release' 
  artifactName: 'drop' 
  
  # Azure Web App Variables (CRITICAL: Replace with your actual values)
  azureServiceName: 'flipsowebapp-gharijit' # <-- Your unique App Service name (e.g., flipsowebapp-gharijit)
  azureSubscription: 'Flipso-AzureRM-Manual' # <-- Your successful Azure Resource Manager Service Connection name
  environmentName: 'Flipso-Production' # <-- The Azure DevOps Environment name you created

# =================================================================
# STAGE 1: Continuous Integration (CI - Build and Package)
# =================================================================
stages:
- stage: Build
  displayName: CI - Build and Package Application
  jobs:
  - job: BuildJob
    pool:
      name: 'default' # <--- CRITICAL CHANGE: Uses your self-hosted agent's pool
    steps:
    
    # 1. Install/Use .NET SDK (Ensures required framework is on the agent)
    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        version: '8.x' 
        packageType: 'sdk'

    # 2. Restore, Build, and Publish the Application
    - task: DotNetCoreCLI@2
      displayName: 'Build and Publish Web App'
      inputs:
        command: 'publish'
        publishWebProjects: true 
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true 

    # 3. Publish Artifact (Saves the .zip file for the Deployment stage)
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: '$(artifactName)'

# =================================================================
# STAGE 2: Continuous Deployment (CD - Deploy to Azure Web App)
# =================================================================
- stage: Deploy
  displayName: CD - Deploy to Azure Web App
  dependsOn: Build 
  condition: succeeded() 
  jobs:
  - deployment: DeployJob
    displayName: Deploy Web App
    environment: $(environmentName) 
    pool:
      name: 'default' # <--- CRITICAL CHANGE: Uses your self-hosted agent for deployment too
      
    strategy: 
      runOnce: 
        deploy: 
          steps: 
          
          # 1. Download Artifact (Pulls the .zip file created in the Build stage)
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Artifact'
            inputs:
              buildType: 'current'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'
              
          # 2. Deploy to Azure Web App 
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: '$(azureSubscription)' 
              appName: '$(azureServiceName)' 
              package: '$(System.ArtifactsDirectory)/$(artifactName)/**/*.zip'
